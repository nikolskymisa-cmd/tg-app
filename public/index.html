<script>
(async () => {
  const tg = window.Telegram.WebApp;
  tg.ready();

  const statusEl = document.getElementById('status');
  const outEl = document.getElementById('out');
  const btnEl = document.getElementById('btn');

  const initData = tg.initData;

  statusEl.textContent = initData
    ? "Открыто внутри Telegram ✅. Авторизуюсь…"
    : "Открыто не из Telegram ❌";

  // таймаут 15 секунд, чтобы не висело бесконечно
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), 15000);

  try {
    const r = await fetch("/auth/telegram", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ initData }),
      signal: controller.signal
    });
    clearTimeout(t);

    if (!r.ok) {
      const txt = await r.text();
      statusEl.textContent = "Ошибка авторизации ❌";
      outEl.textContent = txt;
      return;
    }

    const { token } = await r.json();
    localStorage.setItem("token", token);

    statusEl.textContent = "Авторизация ✅";
    btnEl.style.display = "inline-block";

    btnEl.onclick = async () => {
      const me = await fetch("/me", {
        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
      }).then(x => x.json());

      outEl.textContent = JSON.stringify(me, null, 2);
    };
  } catch (e) {
    statusEl.textContent = "Сервер долго просыпается. Попробуй ещё раз через 10–20 сек.";
    outEl.textContent = String(e);
  }
})();
</script>